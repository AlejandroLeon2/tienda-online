---
const { producto = {} } = Astro.props;
const isEdit = !!producto.id_pr;
---

<form
  enctype="multipart/form-data"
  id="productoForm"
  class="w-[320px] md:w-xl lg:w-full lg:max-w-[800px] xl:max-w-[1000px] mx-auto mt-10 p-8 bg-[#1f1f1f] text-white rounded-lg shadow-lg border border-gray-600"
>
  <input type="hidden" name="_method" value={isEdit ? "PUT" : "POST"} />

  <h2 class="text-2xl font-bold text-center mb-6">
    {isEdit ? "Editar Producto" : "Agregar Producto"}
  </h2>

  <section class="lg:flex lg:gap-4 xl:gap-20 justify-center">
    <section>
      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <div class="w-full">
          <label class="block text-sm font-semibold mb-2" for="nombre_producto">
            Nombre del producto
          </label>
          <input
            class="w-full bg-gray-200 text-gray-900 border border-gray-300 rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500"
            id="nombre_producto"
            type="text"
            placeholder="Nombre del producto"
            name="nombre_producto"
            value={producto.nombre_producto || ""}
            required
          />
        </div>

        <div class="w-full">
          <label
            class="block text-sm font-semibold mb-2"
            for="categoria_producto"
          >
            Categoría
          </label>
          <select
            class="w-full bg-gray-200 text-gray-900 border border-gray-300 rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500"
            id="categoria_producto"
            name="categoria_producto"
            required
          >
            <option value="">Seleccione una categoría</option>
            <option
              value="1"
              selected={producto.categoria_producto === "electronica"}
              >Electrónica</option
            >
            <option value="2" selected={producto.categoria_producto === "ropa"}
              >Ropa</option
            >
            <option value="3" selected={producto.categoria_producto === "hogar"}
              >Hogar</option
            >
            <option
              value="4"
              selected={producto.categoria_producto === "deportes"}
              >Deportes</option
            >
            <option
              value="5"
              selected={producto.categoria_producto === "juguetes"}
              >Juguetes</option
            >
          </select>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <div class="w-full">
          <label class="block text-sm font-semibold mb-2" for="marca_producto">
            Marca
          </label>
          <input
            class="w-full bg-gray-200 text-gray-900 border border-gray-300 rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500"
            id="marca_producto"
            type="text"
            placeholder="Marca del producto"
            name="marca_producto"
            value={producto.marca_producto || ""}
            required
          />
        </div>

        <div class="w-full">
          <label class="block text-sm font-semibold mb-2" for="precio_producto">
            Precio
          </label>
          <input
            class="w-full bg-gray-200 text-gray-900 border border-gray-300 rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500"
            id="precio_producto"
            type="number"
            step="0.01"
            placeholder="Precio"
            name="precio_producto"
            value={producto.precio_producto || ""}
            required
          />
        </div>
      </div>

      <div class="mb-4">
        <label
          class="block text-sm font-semibold mb-2"
          for="descripcion_producto"
        >
          Descripción
        </label>
        <textarea
          class="w-full bg-gray-200 text-gray-900 border border-gray-300 rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500"
          id="descripcion_producto"
          placeholder="Descripción del producto"
          name="descripcion_producto"
          required>{producto.descripcion_producto || ""}</textarea
        >
      </div>
    </section>

    <section>
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2" for="imagen_producto">
          Imagen del producto
        </label>
        <input
          class="w-full bg-gray-200 text-gray-900 border border-gray-300 rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500"
          id="imagen_producto"
          type="file"
          name="imagen_producto"
          accept="image/*"
          required
        />

        <!-- Sección de previsualización de imagen -->
        <div class="mt-4">
          <p class="text-sm text-gray-400 mb-2">Vista previa:</p>
          <div
            class="border-2 border-dashed border-gray-600 rounded-lg p-4 flex justify-center items-center min-h-40"
          >
            <img
              id="preview_imagen"
              src={producto.imagen_url || ""}
              alt="Vista previa de la imagen"
              class={`max-w-full max-h-50 rounded shadow-md ${producto.imagen_url ? "block" : "hidden"}`}
            />
            <p
              id="no-image-text"
              class={`text-gray-500 ${producto.imagen_url ? "hidden" : "block"}`}
            >
            </p>
          </div>
        </div>
      </div>
    </section>
  </section>

  <div class="flex justify-center">
    <button
      type="submit"
      class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-6 rounded focus:outline-none focus:ring-2 focus:ring-yellow-500"
    >
      {isEdit ? "Actualizar" : "Agregar"} producto
    </button>
  </div>
</form>

<!-- Script para manejar la previsualización de imagen -->
<script is:inline>
  // Previsualización de imagen
  const imagenInput = document.getElementById("imagen_producto");
  const previewImagen = document.getElementById("preview_imagen");
  const noImageText = document.getElementById("no-image-text");

  imagenInput?.addEventListener("change", function (event) {
    const file = event.target.files[0];

    if (file) {
      const reader = new FileReader();

      reader.onload = function (e) {
        previewImagen.src = e.target.result;
        previewImagen.classList.remove("hidden");
        previewImagen.classList.add("block");
        noImageText.classList.add("hidden");
        noImageText.classList.remove("block");
      };

      reader.readAsDataURL(file);
    } else {
      previewImagen.src = "";
      previewImagen.classList.add("hidden");
      previewImagen.classList.remove("block");
      noImageText.classList.remove("hidden");
      noImageText.classList.add("block");
    }
  });
</script>


<script is:inline>
  document
    .getElementById("productoForm")
    ?.addEventListener("submit", async function (event) {
      event.preventDefault();

      const form = event.target;
      const formData = new FormData(form);
      const submitButton = form.querySelector('button[type="submit"]');

      try {
        submitButton.disabled = true;
        submitButton.innerHTML = `Enviando...`;


        const response = await fetch("http://localhost:3000/api/productos", {
          method: "POST",
          body: formData, 
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error);
        }

        window.location.href = "/productos";
      } catch (error) {
        alert(`Error: ${error.message}`);
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = "Agregar producto";
      }
    });
</script>
